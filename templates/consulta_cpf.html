{% extends 'base.html' %}
{% block main_content %}
  {% load static %}
  <div class="container">
    <div class="text-center mt-5">
      <h2 class="text-3xl font-bold mb-4">Consulta de CPF</h2>
      <p class="text-muted">Digite o CPF para realizar a consulta.</p>
    </div>
    <div class="alert alert-warning mt-4" role="alert" style="background-color: gold; color: white;">
      <strong>Atenção!:</strong> DIGITE APENAS OS NUMEROS DO CPF, NÃO COLOQUE CARATERES ESPECIAIS (.-!?#@)
    </div>
    <form id="cpfForm" class="mt-5">
      <div class="form-group d-flex justify-content-center">
        <label for="cpf" class="sr-only">CPF:</label>
        <input type="text" name="cpf" id="cpf" class="form-control mr-2" placeholder="Digite apenas números" required pattern="\d{3}\.\d{3}\.\d{3}-\d{2}|\d{11}">
        <button type="button" class="btn btn-primary" id="btnBuscar">
          <span id="btnText">Buscar</span>
          <span id="btnLoader" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
        </button>
      </div>
    </form>
    <div id="loading" class="mt-4 text-center d-none">
      <p class="text-muted">Aguarde, estamos buscando informações. Por favor, aguarde um momento...</p>
      <div class="matrix-loader"></div>
    </div>
    <div id="successCard" class="alert alert-success mt-4 d-none">
      <strong>Consulta Concluída!</strong> Seu arquivo está pronto para download.
    </div>
    <div id="downloadMessage" class="mt-4 text-center d-none">
      <p class="text-muted">Arquivo disponível para download.</p>
      <a href="#" id="downloadBtn" class="btn btn-primary" style="display: none;">
        <span id="downloadBtnText">Baixar PDF</span>
        <span id="downloadBtnLoader" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
      </a>
    </div>
  </div>

  <style>
    .matrix-loader {
      color: #00ff00;
      font-family: 'Courier New', Courier, monospace;
      font-size: 14px;
      white-space: pre;
    }

    /* Centralize o botão de busca */
    #cpfForm .form-group {
      align-items: center;
    }

    /* Estilize o campo de entrada e o botão de busca */
    #cpf {
      width: 250px; /* Ajuste a largura conforme necessário */
    }

    #btnBuscar {
      min-width: 100px; /* Defina uma largura mínima para o botão */
    }
  </style>

  <script>
    const cpfForm = document.getElementById("cpfForm");
    const loading = document.getElementById("loading");
    const btnBuscar = document.getElementById("btnBuscar");
    const btnText = document.getElementById("btnText");
    const btnLoader = document.getElementById("btnLoader");
    const downloadBtn = document.getElementById("downloadBtn");
    const downloadBtnText = document.getElementById("downloadBtnText");
    const downloadBtnLoader = document.getElementById("downloadBtnLoader");
    const successCard = document.getElementById("successCard");
    const downloadMessage = document.getElementById("downloadMessage");

    function typeWriter(element, phrases, speed) {
      let phraseIndex = 0;
      let textIndex = 0;

      function type() {
        if (phraseIndex < phrases.length) {
          if (textIndex < phrases[phraseIndex].length) {
            element.innerHTML += phrases[phraseIndex].charAt(textIndex);
            textIndex++;
            setTimeout(type, speed);
          } else {
            // Move to the next phrase
            phraseIndex++;
            textIndex = 0;
            element.innerHTML = "";
            setTimeout(type, speed * 2); // Pause before typing the next phrase
          }
        }
      }

      type();
    }

    btnBuscar.addEventListener("click", function (e) {
      e.preventDefault();
      loading.classList.remove("d-none");
      btnText.classList.add("d-none");
      btnLoader.classList.remove("d-none");

      let textElement = document.querySelector('.matrix-loader');
      let phrases = [
        "Buscando informações no banco de dados...",
        "Aguarde, seus dados já estão quase lá...",
        "Preparando arquivo para download...",
        "Validando informações do CPF...",
        "Consultando registros...",
        "Processando dados...",
        "Analisando resultados...",
        "Carregando informações adicionais...",
        "Otimizando consulta...",
        "Gerando relatório...",
        "Verificando integridade dos dados...",
        "Encontrando correspondências...",
        "Ajustando detalhes...",
        "Finalizando consulta..."
      ];

      let speed = 60;

      typeWriter(textElement, phrases, speed);

      // Prepare data for AJAX request
      const formData = new FormData(cpfForm);

      // Send AJAX request
      fetch("/consultacpf/", {
        method: "POST",
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.file_url) {
          // Construct correct download URL
          const baseUrl = window.location.origin;
          const fileUrl = `${baseUrl}/${data.file_url.replace('consultacpf/', '')}`;

          downloadBtn.href = fileUrl;
          downloadBtn.style.display = "inline-block";
          successCard.classList.remove("d-none");
          downloadMessage.classList.remove("d-none");
        } else {
          alert("Ocorreu um erro. Tente novamente.");
        }
      })
      .catch(error => {
        console.error("Error:", error);
        alert("Ocorreu um erro. Tente novamente.");
      })
      .finally(() => {
        loading.classList.add("d-none");
        btnText.classList.remove("d-none");
        btnLoader.classList.add("d-none");
      });
    });
  </script>
{% endblock %}
